{% extends "admin_base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Manage Products</h2>

    <!-- Add Product Button -->
    <button class="btn btn-success mb-4" 
            data-bs-toggle="modal" 
            data-bs-target="#productModal"
            data-mode="add">
        Add Product
    </button>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="productForm" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id" id="productId">

                        <!-- Product Name -->
                        <div class="mb-3">
                            <label class="form-label">Product Name</label>
                            <input type="text" class="form-control" name="name" id="productName" required>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="productDescription" rows="3" required></textarea>
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" name="category" id="productCategory" required>
                        </div>

                        <!-- Price -->
                        <div class="mb-3">
                            <label class="form-label">Price ($)</label>
                            <input type="number" step="0.01" class="form-control" name="price" id="productPrice" required>
                        </div>

                        <!-- Image -->
                        <div class="mb-3">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" id="productImage" 
                                   {% raw %}{{ "required" if not product else "" }}{% endraw %}>
                            <small class="text-muted">Image is required when adding a new product.</small>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="modalSubmitBtn">Add Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Products List -->
    <table class="table table-striped">
        <thead class="table-light">
            <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Description</th>
                <th>Category</th>
                <th>Price ($)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="productsTableBody">
            {% for product in products %}
            <tr id="row-{{ product.id }}">
                <td>
                    {% if product.image %}
                    <img src="{{ url_for('static', filename='images/' ~ product.image) }}" width="60" height="60" class="rounded">
                    {% else %}
                    <span class="text-muted">No Image</span>
                    {% endif %}
                </td>
                <td>{{ product.name }}</td>
                <td>{{ product.description }}</td>
                <td>{{ product.category }}</td>
                <td>${{ "%.2f"|format(product.price) }}</td>
                <td>
                    <!-- Edit Button -->
                    <button class="btn btn-warning btn-sm"
                        data-bs-toggle="modal" data-bs-target="#productModal"
                        data-mode="edit"
                        data-id="{{ product.id }}"
                        data-name="{{ product.name }}"
                        data-description="{{ product.description }}"
                        data-category="{{ product.category }}"
                        data-price="{{ product.price }}">
                        Edit
                    </button>

                    <!-- Delete Button -->
                    <button class="btn btn-danger btn-sm" 
                        data-bs-toggle="modal" data-bs-target="#deleteConfirmModal"
                        data-id="{{ product.id }}" 
                        data-name="{{ product.name }}">
                        Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong id="deleteProductName"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteProduct()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Handle Add/Edit Modal show
const productModal = document.getElementById('productModal');
productModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const mode = button.getAttribute('data-mode');

    if (mode === "edit") {
        document.getElementById("productModalTitle").innerText = "Edit Product";
        document.getElementById("modalSubmitBtn").innerText = "Update Product";

        document.getElementById("productId").value = button.getAttribute('data-id');
        document.getElementById("productName").value = button.getAttribute('data-name');
        document.getElementById("productDescription").value = button.getAttribute('data-description');
        document.getElementById("productCategory").value = button.getAttribute('data-category');
        document.getElementById("productPrice").value = button.getAttribute('data-price');
    } else {
        document.getElementById("productModalTitle").innerText = "Add Product";
        document.getElementById("modalSubmitBtn").innerText = "Add Product";
        document.getElementById("productForm").reset();
        document.getElementById("productId").value = "";
    }
});

// Handle Delete Modal
let productToDelete = null;
const deleteModal = document.getElementById('deleteConfirmModal');
deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    productToDelete = button.getAttribute('data-id');
    document.getElementById('deleteProductName').innerText = button.getAttribute('data-name');
});

// Delete Product
async function deleteProduct() {
    if (!productToDelete) return;
    const response = await fetch(`/ecommerce/delete/${productToDelete}`, { method: "DELETE" });
    if (response.ok) {
        document.getElementById(`row-${productToDelete}`).remove();
        productToDelete = null;
        bootstrap.Modal.getInstance(deleteModal).hide();
    } else {
        alert("Failed to delete product.");
    }
}

// Submit Form (Add/Edit)
const productForm = document.getElementById("productForm");
productForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const formData = new FormData(productForm);
    const productId = document.getElementById("productId").value;

    let url = productId ? `/ecommerce/update/${productId}` : "/ecommerce/add";
    let method = productId ? "PUT" : "POST";

    const response = await fetch(url, { method, body: formData });

    if (response.ok) {
        location.reload(); // reload to refresh table
    } else {
        alert("Failed to save product.");
    }
});
</script>
{% endblock %}
